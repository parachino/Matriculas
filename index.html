<html>
<head>
  <style>
    .match {
      color: red;
      font-weight: bold;
    }
    .manual-list {
      white-space: pre-line;
      border: 1px solid #ccc;
      padding: 10px;
      width: 300px;
      height: 200px;
      overflow-y: auto;
    }
  </style>
  <script type="text/javascript">
    let lastPlate = "";
    let scanning = false;
    let manualListRaw = [];

    function onscan(scandata) {
      if (scandata !== lastPlate) {
        lastPlate = scandata;

        const textarea = document.getElementById("plateLog");
        textarea.value += scandata + "\n";
        document.getElementById("lastPlateDisplay").innerText = "√öltima matr√≠cula: " + scandata;

        checkManualListMatch(scandata);
      }

      if (scanning) {
        startscan('platefield1');
      }
    }

    function startscan(platefield) {
      window.location = "readplate://" + platefield;
    }

    function startScanningLoop() {
      if (scanning) return;
      scanning = true;
      updateManualList();
      startscan('platefield1');
    }

    function updateManualList() {
      const raw = document.getElementById("manualInput").value.trim().split("\n");
      manualListRaw = raw.map(p => p.trim().toUpperCase()).filter(p => p !== "");
      renderManualList();
    }

    function renderManualList(matchedPlate = null) {
      const container = document.getElementById("manualListDisplay");
      container.innerHTML = "";
      manualListRaw.forEach(plate => {
        const line = document.createElement("div");
        line.textContent = plate;
        if (matchedPlate && plate === matchedPlate.toUpperCase()) {
          line.classList.add("match");
        }
        container.appendChild(line);
      });
    }

    function checkManualListMatch(scanned) {
      const match = manualListRaw.includes(scanned.toUpperCase());
      renderManualList(match ? scanned : null);
    }

    function saveToFile() {
      const content = document.getElementById("plateLog").value;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "license_plates_log.txt";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function copyLastPlate() {
      if (!lastPlate) return alert("No hay matr√≠cula escaneada a√∫n.");
      navigator.clipboard.writeText(lastPlate).then(() => {
        alert("√öltima matr√≠cula copiada al portapapeles.");
      });
    }

    function copyAllPlates() {
      const all = document.getElementById("plateLog").value;
      if (!all.trim()) return alert("No hay matr√≠culas escaneadas.");
      navigator.clipboard.writeText(all).then(() => {
        alert("Todas las matr√≠culas copiadas al portapapeles.");
      });
    }
  </script>
</head>

<body>
  <h3>Esc√°ner de Matr√≠culas</h3>

  <p id="lastPlateDisplay" style="font-weight: bold;">√öltima matr√≠cula: -</p>

  <input onclick="copyLastPlate()" type="button" value="üìã Copiar √∫ltima matr√≠cula" />
  <input onclick="copyAllPlates()" type="button" value="üìã Copiar todas las matr√≠culas" /><br /><br />

  <textarea id="plateLog" rows="8" cols="50" placeholder="Aqu√≠ se ir√°n listando las matr√≠culas..."></textarea><br /><br />

  <input onclick="saveToFile()" type="button" value="Guardar archivo con matr√≠culas" />

  <br /><br /><hr><br />

  <h4>Insertar matr√≠culas manuales (una por l√≠nea):</h4>
  <textarea id="manualInput" rows="8" cols="30" placeholder="Ej:\n1234ABC\n5678DEF"></textarea><br>
  <button onclick="updateManualList()">Actualizar lista</button>

  <h4>Lista con coincidencias marcadas:</h4>
  <div id="manualListDisplay" class="manual-list"></div>

  <br /><br /><br />

  <input onclick="startScanningLoop()" type="button" value="üîÅ Iniciar escaneo continuo de matr√≠culas" />
</body>
</html>
