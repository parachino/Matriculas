<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escaneo de Matrículas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    textarea {
      width: 100%;
      height: 100px;
      resize: none;
    }
    #historial, #listaNegra {
      width: 100%;
      height: 150px;
      resize: none;
    }
    .coincidencia {
      background-color: red;
      color: white;
    }
    .separador {
      margin-top: 3em;
    }
  </style>
</head>
<body>

<h2>Lista negra de matrículas (puedes escribir o cargar un archivo .txt)</h2>
<textarea id="listaNegra" placeholder="Escribe o carga matrículas prohibidas aquí..."></textarea><br>
<input type="file" id="archivoListaNegra" accept=".txt">

<h2>Historial de coincidencias</h2>
<textarea id="historial" readonly></textarea><br>

<label>Número de coincidencias:</label>
<input type="text" id="contadorCoincidencias" readonly value="0"><br><br>

<button onclick="copiarUltima()">Copiar última matrícula leída</button>
<button onclick="copiarTodas()">Copiar todas las coincidencias</button>

<div class="separador"></div>

<button onclick="iniciarEscaneo()">Iniciar escaneo continuo</button>

<script>
  let escaneando = false;
  let historial = [];
  let coincidencias = [];

  function onscan(scandata) {
    if (!escaneando) return;

    const fecha = new Date().toLocaleString();
    const coincidenciasLista = obtenerListaNegra();
    const coincidenciasEncontradas = [];

    const entrada = `${scandata} - ${fecha}`;
    
    // Buscar coincidencias
    coincidenciasLista.forEach(matricula => {
      if (entrada.includes(matricula)) {
        coincidenciasEncontradas.push(matricula);
      }
    });

    const linea = `${scandata} - ${fecha}` + (coincidenciasEncontradas.length > 0 ? ` - coincidencias: ${coincidenciasEncontradas.join(', ')}` : '');

    // Insertar la nueva entrada al principio del historial
    historial.unshift(linea);

    // Si hay coincidencias, marcar y detener escaneo
    if (coincidenciasEncontradas.length > 0) {
      coincidencias.unshift(linea);
      actualizarHistorial();
      document.getElementById("contadorCoincidencias").value = coincidencias.length;

      // Alerta con TODAS las coincidencias actuales
      alert("¡Coincidencias detectadas!\n\n" + coincidencias.join("\n"));

      escaneando = false;
      return;
    }

    actualizarHistorial();

    // Continuar escaneo
    if (escaneando) {
      setTimeout(() => simularLectura(), 1000); // simular escaneo continuo
    }
  }

  function obtenerListaNegra() {
    return document.getElementById("listaNegra").value
      .split("\n")
      .map(m => m.trim())
      .filter(m => m.length > 0);
  }

  function actualizarHistorial() {
    const campoHistorial = document.getElementById("historial");
    campoHistorial.value = coincidencias.join("\n");
  }

  function iniciarEscaneo() {
    escaneando = true;
    simularLectura();
  }

  function simularLectura() {
    // Aquí deberías integrar la llamada real al escáner de matrículas
    // Para prueba, genera una matrícula aleatoria
    const placasPrueba = ["1234ABC", "5678DEF", "1111AAA", "9999ZZZ", "TEST123"];
    const aleatoria = placasPrueba[Math.floor(Math.random() * placasPrueba.length)];
    onscan(aleatoria);
  }

  function copiarUltima() {
    if (historial.length > 0) {
      navigator.clipboard.writeText(historial[0]);
      alert("Última matrícula copiada.");
    }
  }

  function copiarTodas() {
    navigator.clipboard.writeText(coincidencias.join("\n"));
    alert("Todas las coincidencias copiadas.");
  }

  // Cargar archivo de lista negra
  document.getElementById("archivoListaNegra").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      document.getElementById("listaNegra").value = e.target.result;
    };
    reader.readAsText(file);
  });
</script>

</body>
</html>
