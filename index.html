<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lector de MatrÃ­culas</title>
  <style>
    body { font-family: sans-serif; }
    .match {
      background-color: red;
      color: white;
      font-weight: bold;
    }
    textarea, input[type="text"] {
      resize: none;
    }
    #manualListDisplay, #scanHistory {
      border: 1px solid #000;
      padding: 10px;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }
    .line {
      margin-bottom: 4px;
    }
  </style>
  <script>
    let scanning = false;
    let manualListRaw = [];
    let alertPlayedForPlates = new Set();

    function onscan(scandata) {
      const plate = scandata.toUpperCase();
      document.getElementById("lastPlate").textContent = plate;
      const timestamp = new Date().toLocaleString();
      const matchCount = checkManualListMatch(plate);
      addToScanHistory(plate, timestamp, matchCount);

      // Solo sonar si es la primera vez que se detecta esa matrÃ­cula con coincidencia
      if (matchCount > 0 && !alertPlayedForPlates.has(plate)) {
        document.getElementById("beep").play();
        alertPlayedForPlates.add(plate);
        scanning = false;
      } else if (scanning) {
        setTimeout(() => startscan(), 500);
      }
    }

    function startscan() {
      if (!scanning) scanning = true;
      window.location = "readplate://dummy";
    }

    function copyLastPlate() {
      const text = document.getElementById("lastPlate").textContent;
      navigator.clipboard.writeText(text);
    }

    function copyAllPlates() {
      const lines = Array.from(document.getElementById("scanHistory").children);
      const text = lines.map(line => line.textContent).join("\n");
      navigator.clipboard.writeText(text);
    }

    function updateManualList() {
      const raw = document.getElementById("manualListInput").value;
      manualListRaw = raw.toUpperCase().split(/\n/).map(l => l.trim()).filter(l => l !== "");
      renderManualList([]);
    }

    function renderManualList(matchedIndices = []) {
      const container = document.getElementById("manualListDisplay");
      container.innerHTML = "";
      manualListRaw.forEach((plate, index) => {
        const line = document.createElement("div");
        line.textContent = plate;
        line.className = "line";
        if (matchedIndices.includes(index)) line.classList.add("match");
        container.appendChild(line);
      });
    }

    function checkManualListMatch(scanned) {
      const scannedUpper = scanned.toUpperCase();
      const matches = [];
      const matchedLines = [];

      for (let i = 0; i < manualListRaw.length; i++) {
        if (manualListRaw[i].includes(scannedUpper)) {
          matches.push(i);
          matchedLines.push(manualListRaw[i]);
        }
      }

      renderManualList(matches);
      updateMatchCount(matches.length);
      addMatchesToHistory(matches);

      // Mostrar alerta solo si hay lÃ­neas coincidentes
      if (matchedLines.length > 0) {
        alert("âš ï¸ Coincidencias detectadas:\n\n" + matchedLines.join("\n"));
      }

      return matches.length;
    }

    function updateMatchCount(count) {
      document.getElementById("matchCount").value = count;
    }

    function addMatchesToHistory(matchIndices) {
      const manualLines = manualListRaw;
      const history = document.getElementById("scanHistory");
      matchIndices.forEach(i => {
        const entry = document.createElement("div");
        entry.textContent = manualLines[i];
        entry.className = "match";
        history.prepend(entry);
      });
    }

    function addToScanHistory(plate, timestamp, count) {
      const history = document.getElementById("scanHistory");
      const entry = document.createElement("div");
      entry.textContent = `${plate} â€“ ${timestamp} â€“ ${count} coincidencia${count !== 1 ? "s" : ""}`;
      entry.className = "line";
      history.prepend(entry);
    }

    function loadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById("manualListInput").value = content;
        updateManualList();
      };
      reader.readAsText(file);
    }

    function downloadHistory() {
      const lines = Array.from(document.getElementById("scanHistory").children);
      const text = lines.map(line => line.textContent).join("\n");
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "historial_matriculas.txt";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</head>
<body>
  <h2>Lectura de MatrÃ­culas</h2>

  <p>Ãšltima matrÃ­cula leÃ­da: <strong id="lastPlate">---</strong></p>

  <button onclick="copyLastPlate()">ðŸ“‹ Copiar Ãºltima matrÃ­cula</button>
  <button onclick="copyAllPlates()">ðŸ“‹ Copiar todas</button>
  <button onclick="downloadHistory()">ðŸ’¾ Guardar historial</button>

  <br><br>

  <label>NÃºmero de coincidencias:</label>
  <input type="text" id="matchCount" value="0" readonly style="width: 40px; text-align: center;" />

  <h3>ðŸ§¾ Lista manual de matrÃ­culas (lista negra):</h3>
  <input type="file" accept=".txt" onchange="loadFile(event)" />
  <br><br>
  <textarea id="manualListInput" oninput="updateManualList()" rows="6" cols="40" style="width: 100%;"></textarea>
  <div id="manualListDisplay"></div>

  <h3>ðŸ“‹ Historial de lecturas (Ãºltima arriba):</h3>
  <div id="scanHistory"></div>

  <br><br><br>

  <button onclick="startscan()" style="font-size: 20px">ðŸ“· Iniciar escaneo continuo de matrÃ­culas</button>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
</body>
</html>
