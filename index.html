<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lector de Matrículas</title>
  <style>
    .match {
      background-color: red;
      color: white;
      font-weight: bold;
    }
  </style>
  <script>
    let scanning = false;
    let manualListRaw = [];

    function onscan(scandata) {
      const plate = scandata.toUpperCase();
      document.getElementById("lastPlate").textContent = plate;
      addPlate(plate);
      const matchFound = checkManualListMatch(plate);
      addToScanHistory(plate, document.getElementById("matchCount").value);
      if (matchFound) {
        document.getElementById("beep").play();
        scanning = false;
      } else if (scanning) {
        setTimeout(() => startscan(""), 500);
      }
    }

    function startscan() {
      if (!scanning) {
        scanning = true;
        setTimeout(() => startscan(""), 500);
      }
      window.location = "readplate://dummy";
    }

    function addPlate(plate) {
      const list = document.getElementById("platesList");
      const line = document.createElement("div");
      line.textContent = plate;
      list.appendChild(line);
    }

    function copyLastPlate() {
      const text = document.getElementById("lastPlate").textContent;
      navigator.clipboard.writeText(text);
    }

    function copyAllPlates() {
      const lines = Array.from(document.getElementById("platesList").children);
      const text = lines.map(line => line.textContent).join("\n");
      navigator.clipboard.writeText(text);
    }

    function updateManualList() {
      const raw = document.getElementById("manualListInput").value;
      manualListRaw = raw.toUpperCase().split(/\n/).map(l => l.trim());
      renderManualList([]);
    }

    function renderManualList(matchedIndices = []) {
      const container = document.getElementById("manualListDisplay");
      container.innerHTML = "";
      manualListRaw.forEach((plate, index) => {
        const line = document.createElement("div");
        line.textContent = plate;
        if (matchedIndices.includes(index)) {
          line.classList.add("match");
        }
        container.appendChild(line);
      });
    }

    function checkManualListMatch(scanned) {
      const scannedUpper = scanned.toUpperCase();
      const matches = [];
      for (let i = 0; i < manualListRaw.length; i++) {
        if (manualListRaw[i].includes(scannedUpper)) {
          matches.push(i);
        }
      }
      renderManualList(matches);
      updateMatchCount(matches.length);
      return matches.length > 0;
    }

    function updateMatchCount(count) {
      const counter = document.getElementById("matchCount");
      counter.value = count;
    }

    function addToScanHistory(plate, count) {
      const history = document.getElementById("scanHistory");
      const entry = document.createElement("div");
      entry.textContent = `${plate} → ${count} coincidencia${count !== "1" ? "s" : ""}`;
      history.appendChild(entry);
    }
  </script>
</head>
<body>
  <h2>Lectura de Matrículas</h2>
  <p>Última matrícula leída: <strong id="lastPlate">---</strong></p>
  <button onclick="copyLastPlate()">Copiar última matrícula</button>
  <button onclick="copyAllPlates()">Copiar todas</button>
  <br><br>
  <label>Número de coincidencias:</label>
  <input type="text" id="matchCount" value="0" readonly style="width: 40px; text-align: center;">

  <h3>📝 Matrículas leídas:</h3>
  <div id="platesList" style="border: 1px solid #000; padding: 10px; min-height: 100px;"></div>

  <h3>🧾 Lista manual de matrículas:</h3>
  <textarea id="manualListInput" oninput="updateManualList()" rows="6" cols="40"></textarea>
  <div id="manualListDisplay" style="border: 1px solid #ccc; padding: 10px; min-height: 100px; margin-top: 10px;"></div>

  <h3>🕘 Historial de matrículas escaneadas</h3>
  <div id="scanHistory" style="border: 1px solid #ccc; padding: 10px; min-height: 50px; background: #f9f9f9;"></div>

  <br><br><br>
  <button onclick="startscan()" style="font-size: 20px">📷 Iniciar escaneo continuo de matrículas</button>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
</body>
</html>
