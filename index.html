<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lector de MatrÃ­culas</title>
  <style>
    body { font-family: sans-serif; }
    .match { background-color: red; color: white; font-weight: bold; }
    textarea, input[type="text"] { resize: none; }
    #manualListDisplay, #scanHistory {
      border: 1px solid #000;
      padding: 10px;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }
    .line { margin-bottom: 4px; }
  </style>
</head>
<body>
  <h2>Lectura de MatrÃ­culas</h2>

  <p>Ãšltima matrÃ­cula leÃ­da: <strong id="lastPlate">---</strong></p>
  <button onclick="copyLastPlate()">Copiar Ãºltima matrÃ­cula</button>
  <button onclick="copyAllPlates()">Copiar todas</button>

  <br><br>

  <label>NÃºmero de coincidencias:</label>
  <input type="text" id="matchCount" value="0" readonly style="width: 40px; text-align: center;" />

  <h3>ðŸ§¾ Lista manual de matrÃ­culas:</h3>
  <input type="file" accept=".txt" onchange="loadFile(event)" />
  <br><br>
  <textarea id="manualListInput" oninput="updateManualList()" rows="6" cols="40" style="width: 100%;"></textarea>
  <div id="manualListDisplay"></div>

  <h3>ðŸ“‹ Historial de lecturas:</h3>
  <div id="scanHistory"></div>

  <br><br>
  <button onclick="startscan()" style="font-size: 20px">ðŸ“· Iniciar escaneo</button>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <script>
    let scanning = false;
    let manualListRaw = [];
    let lastPlateSeen = ""; // para el historial

    function onscan(scandata) {
      const plate = scandata.toUpperCase();
      document.getElementById("lastPlate").textContent = plate;

      const timestamp = new Date().toLocaleString();

      const matchIndices = getMatchingIndices(plate);
      renderManualList(matchIndices);
      updateMatchCount(matchIndices.length);

      if (plate !== lastPlateSeen) {
        addToScanHistory(plate, timestamp, matchIndices.length);
        lastPlateSeen = plate;
      }

      if (matchIndices.length > 0) {
        document.getElementById("beep").play();
        setTimeout(() => {
          alert(getAllMatchedLines().join('\n'));
        }, 100);
      }

      if (scanning) {
        setTimeout(() => startscan(), 500);
      }
    }

    function startscan() {
      if (!scanning) scanning = true;
      window.location = "readplate://dummy";
    }

    function copyLastPlate() {
      const text = document.getElementById("lastPlate").textContent;
      navigator.clipboard.writeText(text);
    }

    function copyAllPlates() {
      const lines = Array.from(document.getElementById("scanHistory").children);
      const text = lines.map(line => line.textContent).join("\n");
      navigator.clipboard.writeText(text);
    }

    function updateManualList() {
      const raw = document.getElementById("manualListInput").value;
      manualListRaw = raw.toUpperCase().split(/\n/).map(l => l.trim()).filter(l => l !== "");
      renderManualList([]);
    }

    function renderManualList(matchedIndices = []) {
      const container = document.getElementById("manualListDisplay");
      container.innerHTML = "";
      manualListRaw.forEach((plate, index) => {
        const line = document.createElement("div");
        line.textContent = plate;
        line.className = "line";
        if (matchedIndices.includes(index)) {
          line.classList.add("match");
        }
        container.appendChild(line);
      });
    }

    function getMatchingIndices(plate) {
      return manualListRaw.map((entry, i) => entry.includes(plate) ? i : -1).filter(i => i >= 0);
    }

    function updateMatchCount(count) {
      document.getElementById("matchCount").value = count;
    }

    function getAllMatchedLines() {
      return Array.from(document.querySelectorAll("#manualListDisplay .match"))
                  .map(el => el.textContent);
    }

    function addToScanHistory(plate, timestamp, matchCount) {
      const history = document.getElementById("scanHistory");
      const entry = document.createElement("div");
      entry.textContent = `${plate} â€“ ${timestamp} â€“ ${matchCount} coincidencia${matchCount !== 1 ? "s" : ""}`;
      entry.className = "line";
      history.prepend(entry);
    }

    function loadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("manualListInput").value = e.target.result;
        updateManualList();
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
